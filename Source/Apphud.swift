//
//  Apphud.swift
//  Apphud
//
//  Created by ren6 on 28/04/2019.
//  Copyright Â© 2019 Softeam. All rights reserved.
//

import UIKit
import StoreKit
import AdSupport

private typealias ApphudBoolDictionaryCallback = (Bool, [String : Any]?, Error?) -> Void

public class Apphud: NSObject {
    
    public var configuration : ApphudConfiguration!
    
    /**
     Initializes Apphud SDK.
     
     This is mandatory initialize method. Better to call it within `application:didFinishLaunchingWithOptions:`.
     
     - parameter apiKey: Required. Your api key.
     - parameter userID: Optional. You can provide your own unique user identifier. If nil then NSUUID will be generated instead.
     */
    public static func start(apiKey: String, configuration : ApphudConfiguration? = nil) {
        if shared == nil {
            shared = Apphud()
        }
        if configuration == nil {
            let config = ApphudConfiguration(anUserID: Apphud.getUserID())
            shared.configuration = config
        } else {
            shared.configuration = configuration!
        }
        shared.apiKey = apiKey        
        shared.initialize()
    }
    
    /**
     Reports successfully purchased product to Apphud server. 
     
     Call it after purchase has been made. Apphud servers will validate receipt automatically and send purchase events to your Analytics when trial is converted to paid subscription. If this is a non trial subscription then events to Analytics will be sent immediately.     
     
     - parameter product: Required. This is an SKProduct class object that has been purchased.
     - parameter callback: Optional. Returns true if revenue has been successfully submitted. Returns false and `error` otherwise. Note that `error` may be nil.
     */
    public static func reportRevenue(product : SKProduct, callback : ((Bool, Error?) -> Void)?) {
        guard let manager = shared else {
            callback?(false, nil)
            return
        }
        guard let currencyCode = product.priceLocale.currencyCode else {
            callback?(false, nil)
            return
        }
        guard let appStoreReceiptURL = Bundle.main.appStoreReceiptURL else {
            callback?(false, nil)
            return
        }
        var receiptData: Data? = nil
        do {
            receiptData = try Data(contentsOf: appStoreReceiptURL)
        }
        catch {}
        if receiptData == nil {
            callback?(false, nil)
            return
        }
        
        var environment = "production"
        #if DEBUG
        environment = "sandbox"
        #endif
        let params : [String : Any] = ["user_id" : manager.configuration.user_id,
                                       "currency" : currencyCode,
                                       "price" : product.price.doubleValue,
                                       "receipt_data" : receiptData!.base64EncodedString(),
                                       "environment" : environment]
        
        if let request = manager.getRequest(path: "subscriptions", params: params, method: "POST") {
            manager.start(request: request) { (result, info, error) in
                callback?(result, error)
            }
        }
    }
    
    // MARK:- PRIVATE
    
    private static var shared: Apphud!
    private var apiKey : String = ""
    private let domain_url_string = "http://analytics.atlantapps.com"
    
    private lazy var session : URLSession = {
        let config = URLSessionConfiguration.default
        return URLSession.init(configuration: config)
    }()
    
    private func initialize(){
        registerUser { (result, dictionary, error) in
            if result {
                print("Apphud: User submitted")
                self.getProducts(callback: { (result2, dictionary2, error2) in
                    if result2, let dataDict = dictionary2?["data"] as? [String : Any] {
                        if let productsArray = dataDict["results"] as? [[String : Any]] {
                            var productIDs = Set<String>()
                            for product in productsArray {
                                let productID = product["product_id"] as! String
                                print("Apphud: Product received: ", productID)
                                productIDs.insert(productID)
                            }
                            if productIDs.count > 0 {
                                let productsRequest = SKProductsRequest(productIdentifiers: productIDs)
                                productsRequest.delegate = self
                                productsRequest.start()
                            }
                        }
                    }
                })
            } else {
                print("Apphud: User submit error : \(error?.localizedDescription ?? "")")
            }
        }
    }
    
    private class func getUserID() -> String {
        if let anUserID = ApphudKeychain.loadUserID() {
            return anUserID
        } else {
            let anUserID = ApphudKeychain.generateUserID()
            return anUserID
        }
    }
   
    private static func identifierForAdvertising() -> String? {
        // Check whether advertising tracking is enabled
        guard ASIdentifierManager.shared().isAdvertisingTrackingEnabled else {
            return nil
        }
        
        // Get and return IDFA
        return ASIdentifierManager.shared().advertisingIdentifier.uuidString
    }
    
    // MARK: API Requests
    
    private func registerUser(callback: @escaping ApphudBoolDictionaryCallback) {
        guard let currencyCode = Locale.current.currencyCode else {
            callback(false, nil, nil)
            return
        }
        let params: [String : Any] = ["user_id" : configuration.user_id, "locale" : Locale.current.identifier, "currency" : currencyCode]
        if let request = getRequest(path: "users", params: params, method: "POST") {
            start(request: request, callback: callback)
        }
    }
    
    private func getProducts(callback: @escaping ApphudBoolDictionaryCallback) {
        if let request = getRequest(path: "products", params: nil, method: "GET") {
            start(request: request, callback: callback)
        }
    }
    
    private func submitProducts(products: [SKProduct], callback : @escaping ApphudBoolDictionaryCallback) {
        var array = [[String : Any]]()
        for product in products {
            if let currencyCode = product.priceLocale.currencyCode {
                let product_json : [String : Any] = ["product_id" : product.productIdentifier,
                                                     "currency" : currencyCode,
                                                     "price" : product.price.doubleValue]
                array.append(product_json)
            }
        }
        let params = ["products" : array] as [String : Any]
        if let request = getRequest(path: "products", params: params, method: "PUT") {
            start(request: request, callback: callback)
        }
    }
    
    // MARK: Request Helpers
    
    private func getRequest(path : String, params : [String : Any]?, method : String) -> URLRequest? {
        var request: URLRequest? = nil
        do {
            var url: URL? = nil
            if method == "GET" {
                var components = URLComponents(string: "\(domain_url_string)/v1/app/\(path)")
                var items: [URLQueryItem] = [URLQueryItem(name: "api_key", value: apiKey)]
                if let requestParams = params {
                    for key in requestParams.keys {
                        items.append(URLQueryItem(name: key, value: requestParams[key] as? String))
                    }
                }
                components?.queryItems = items
                url = components?.url
            }
            else {
                url = URL(string: "\(domain_url_string)/v1/app/\(path)")
            }
            guard let finalURL = url else {
                return nil
            }
            
            request = URLRequest(url: finalURL, cachePolicy: URLRequest.CachePolicy.useProtocolCachePolicy, timeoutInterval: 20)
            request?.httpMethod = method
            request?.setValue("application/json; charset=utf-8", forHTTPHeaderField: "Content-Type")
            request?.setValue("application/json; charset=utf-8", forHTTPHeaderField: "Accept")
            
            if method != "GET" {
                var finalParams : [String : Any] = ["api_key" : apiKey]
                if params != nil {
                    finalParams.merge(params!, uniquingKeysWith: {$1})
                }
                let data = try JSONSerialization.data(withJSONObject: finalParams, options: .prettyPrinted)
                request?.httpBody = data
            }
        } catch {
            
        }
        return request
    }
    
    private func start(request: URLRequest, callback: ApphudBoolDictionaryCallback?){
        let task = session.dataTask(with: request) { (data, response, error) in
            if let httpResponse = response as? HTTPURLResponse {
                let code = httpResponse.statusCode
                if code < 300 {
                    var dictionary: [String : Any]?
                    if data != nil {
                        do {
                            dictionary = try JSONSerialization.jsonObject(with: data!, options: []) as? [String:Any]
                        } catch {}
                    }
                    callback?(true, dictionary, nil)
                    return
                }
            }
            callback?(false, nil, error)
        }
        task.resume()
    }
}

extension Apphud : SKProductsRequestDelegate {
    
    public func productsRequest(_ request: SKProductsRequest, didReceive response: SKProductsResponse) {
        if response.products.count > 0 {
            print("Apphud: Products info received from Apple \(response.products)")
            self.submitProducts(products: response.products, callback: { (result3, dictionary3, error3) in
                if result3 {
                    print("Apphud: Products submitted")
                } else {
                    print("Apphud: Products submit error: \(error3?.localizedDescription ?? "")")
                }
            })
        }
    }
}



/*
 
 POST /v1/users?user_id={user_id}&locale={locale}&currency={currency}&api_key={api_key} â Create User
 GET /v1/products?api_key={api_key} â ÐÐ¾Ð»ÑÑÐ¸ÑÑ ÑÐ¿Ð¸ÑÐ¾Ðº product_id, ÑÑÐ¾Ð±Ñ Ð·Ð°Ð¿ÑÐ¾ÑÐ¸ÑÑ Ð´Ð»Ñ Ð½Ð¸Ñ Ð°ÐºÑÑÐ°Ð»ÑÐ½ÑÑ ÑÐµÐ½Ñ Ñ ÑÑÑÑÐ¾Ð¹ÑÑÐ²Ð°.
 PUT /v1/products?api_key={api_key}&product_id={product_id}&currency={currency}&price={price} â ÐÐ±Ð½Ð¾Ð²Ð¸ÑÑ ÑÐµÐ½Ñ Ð¿ÑÐ¾Ð´ÑÐºÑÐ° Ð´Ð»Ñ ÐºÐ¾Ð½ÐºÑÐµÑÐ½Ð¾Ð¹ Ð²Ð°Ð»ÑÑÑ, Ð¿Ð¾ÑÐ»Ðµ ÐµÑ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð½Ð²ÐµÑÑÐ¸ÑÑÐµÐ¼ ÑÑÑ Ð²Ð°Ð»ÑÑÑ Ð² Ð±Ð°ÐºÑ Ð¸ Ð·Ð°Ð¿Ð¸ÑÑÐ²Ð°ÐµÐ¼ ÑÐµÐ½Ñ Ð² Ð±Ð°ÐºÑÐ°Ñ Ð² Ð¾ÑÐ´ÐµÐ»ÑÐ½ÑÑ ÐºÐ¾Ð»Ð¾Ð½ÐºÑ.
 POST /v1/subscriptions?user_id={user_id}&receipt_data={receipt_data}&receipt={receipt}&api_key={api_key}&price={price}&currency={currency} â Create Subscription. Ð¢ÑÑ Ð²Ð¾ Ð²ÑÐµÐ¼Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¼Ñ Ð¸Ð¼ÐµÐµÐ¼ receipt, Ð¸Ð· ÐºÐ¾ÑÐ¾ÑÐ¾Ð³Ð¾ Ð¿Ð¾Ð»ÑÑÐ°ÐµÐ¼ Ð¾Ð¿Ð»Ð°ÑÐµÐ½ÑÐ¹ product_id, Ñ Ð¿Ð¾Ð¼Ð¾ÑÑÑ Ð½ÐµÐ³Ð¾ Ð¼Ñ ÑÐ·Ð½Ð°ÐµÐ¼ Ð°ÐºÑÑÐ°Ð»ÑÐ½ÑÑ ÑÐµÐ½Ñ Ð² Ð±Ð°ÐºÑÐ°Ñ Ð½Ð° ÑÑÐ¾Ñ Ð¿ÑÐ¾Ð´ÑÐºÑ Ð² Ð½Ð°ÑÐµÐ¹ Ð±Ð´ Ð¸ ÑÑÐ° ÑÐµÐ½Ð° Ð·Ð°Ð¿Ð¸ÑÑÐ²Ð°ÐµÑÑÑ Ð¶ÐµÑÑÐºÐ¾ Ð² ÑÐ°Ð¼Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑ, Ð´Ð°Ð»ÐµÐµ ÐºÐ°Ð¶Ð´ÑÐ¹ ÑÐµÐ±Ð¸Ð» Ð±ÑÐ´ÐµÑ ÑÑÐ¸ÑÐ°ÑÑÑÑ Ð¿Ð¾ ÑÑÐ¾Ð¹ ÑÐµÐ½Ðµ Ð¸ Ð¾ÑÐ¿ÑÐ°Ð²Ð»ÑÑÑÑÑ Ð² Ð°Ð½Ð°Ð»Ð¸ÑÐ¸ÐºÑ. ÐÑÐ»Ð¸ Ð¿ÑÐ¾Ð´ÑÐºÑ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð½Ð°ÑÐµÐ¹ Ð±Ð´ Ð¿Ð¾ ÐºÐ°ÐºÐ¸Ð¼-ÑÐ¾ Ð¿ÑÐ¸ÑÐ¸Ð½Ð°Ð¼, ÑÐ¾ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ ÑÑÐ¾Ñ Ð¿ÑÐ¾Ð´ÑÐºÑ Ð¸ ÑÐµÐ½Ñ Ð´Ð»Ñ Ð½ÐµÐ³Ð¾.
 
 ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ Ð¡ÐµÐ»Ð¸Ð²Ð°Ð½Ð¾Ð², [28 Apr 2019 at 09:23:23]:
 PUT /v1/products?api_key={api_key}&products={products} â ÐÐ±Ð½Ð¾Ð²Ð¸ÑÑ ÑÐµÐ½Ñ Ð¿ÑÐ¾Ð´ÑÐºÑÐ° Ð´Ð»Ñ ÐºÐ¾Ð½ÐºÑÐµÑÐ½Ð¾Ð¹ Ð²Ð°Ð»ÑÑÑ, Ð¿Ð¾ÑÐ»Ðµ ÐµÑ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð½Ð²ÐµÑÑÐ¸ÑÑÐµÐ¼ ÑÑÑ Ð²Ð°Ð»ÑÑÑ Ð² Ð±Ð°ÐºÑ Ð¸ Ð·Ð°Ð¿Ð¸ÑÑÐ²Ð°ÐµÐ¼ ÑÐµÐ½Ñ Ð² Ð±Ð°ÐºÑÐ°Ñ Ð² Ð¾ÑÐ´ÐµÐ»ÑÐ½ÑÑ ÐºÐ¾Ð»Ð¾Ð½ÐºÑ.
 
 {products} = {
 product_id: product_id,
 currency: currency,
 price: price
 }
 
 Ð²Ð¾Ñ ÑÑÐ¾Ñ ÐµÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ Ð»ÑÑÑÐµ Ð¼Ð°ÑÑÐ¾Ð²Ð¾ Ð²ÑÐµ ÑÐµÐ½Ñ Ð¿Ð¾ Ð½ÑÐ¶Ð½ÑÐ¼ Ð¿ÑÐ¾Ð´ÑÐºÑÐ°Ð¼ ÑÐ»Ð°ÑÑ.
 */
